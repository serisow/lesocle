<?php

use Drupal\Core\Url;
use Drupal\Core\Render\Markup;
use Drupal\Core\StringTranslation\TranslatableMarkup;
/**
 * Implements hook_mail().
 */
function pipeline_mail($key, &$message, $params) {
  switch ($key) {
    case 'new_article_notification':
      $template = [
        '#theme' => 'pipeline_new_article_notification',
        '#title' => $params['title'],
        '#view_url' => $params['view_url'],
        '#edit_url' => $params['edit_url'],
      ];
      $html = \Drupal::service('renderer')->renderRoot($template);
      $message['subject'] = $params['subject'];
      $message['body'] = [Markup::create($html)];
      $message['headers']['Content-Type'] = 'text/html; charset=UTF-8';
      break;
  }
}

/**
 * Implements hook_theme().
 */
function pipeline_theme($existing, $type, $theme, $path) {
  return [
    'pipeline_new_article_notification' => [
      'variables' => [
        'title' => NULL,
        'view_url' => NULL,
        'edit_url' => NULL,
      ],
      'template' => 'pipeline-new-article-notification',
    ],
    'pipeline_dashboard' => [
      'variables' => [
        'stats' => [],
        'recent_pipelines' => [],
        'quick_actions' => [],
        'system_status' => [],
      ],
      // This tells Drupal to look in themes for overrides
      'path' => $path . '/templates',  // Specify the path
      'template' => 'pipeline-dashboard',
    ],
  ];
}


/**
 * Implements hook_toolbar().
 */
function pipeline_toolbar() {
  $items['shortcuts'] = [
    '#cache' => [
      'contexts' => [
        'user.permissions',
      ],
    ],
  ];

  $items['pipeline'] = [
    '#type' => 'toolbar_item',
    'tab' => [
      '#type' => 'link',
      '#title' => t('Pipeline Management'),
      '#url' => Url::fromRoute('entity.pipeline.collection'),
      '#attributes' => [
        'title' => t('Pipeline management'),
        'class' => ['toolbar-icon', 'toolbar-icon-pipeline'],
      ],
    ],
    'tray' => [
      '#heading' => t('Pipeline management'),
      'content' => [
        '#theme' => 'links__toolbar_pipeline',
        '#links' => [
          'dashboard' => [
            'title' => t('Dashboard'),
            'url' => Url::fromRoute('pipeline.dashboard'),
          ],
          'pipelines' => [
            'title' => t('Pipelines'),
            'url' => Url::fromRoute('entity.pipeline.collection'),
          ],
          'llm_config' => [
            'title' => t('LLM Configuration'),
            'url' => Url::fromRoute('entity.llm_config.collection'),
          ],
          'action_config' => [
            'title' => t('Action Config'),
            'url' => Url::fromRoute('entity.action_config.collection'),
          ],
          'prompt_template' => [
            'title' => t('Prompt templates'),
            'url' => Url::fromRoute('entity.prompt_template.collection'),
          ],
          'custom_google_search_settings' => [
            'title' => t('Custom Google Search'),
            'url' => Url::fromRoute('pipeline.google_settings'),
          ],
        ],
        '#attributes' => [
          'class' => ['toolbar-menu'],
        ],
      ],
    ],
    '#weight' => 1000,
  ];
  return $items;
}


/**
 * Implements hook_page_attachments().
 */
function pipeline_page_attachments(array &$attachments) {
  $attachments['#attached']['library'][] = 'pipeline/toolbar';
}


/**
 * Implements hook_views_data_alter().
 */
function pipeline_views_data_alter(array &$data) {
  // Make sure the base table group exists
  if (isset($data['media__field_rag_indexing_status'])) {
    // Filter handler
    $data['media__field_rag_indexing_status']['field_rag_indexing_status_value']['filter'] = [
      'title' => t('RAG Indexing Status'),
      'help' => t('Filter by RAG indexing status.'),
      'field' => 'field_rag_indexing_status_value',
      'id' => 'rag_indexing_status_filter',
    ];

    // Field handler
    $data['media__field_rag_indexing_status']['field_rag_indexing_status_value']['field'] = [
      'title' => t('RAG Status'),
      'help' => t('Displays the RAG indexing status with formatting.'),
      'id' => 'field_rag_indexing_status',
      'field_name' => 'field_rag_indexing_status',
    ];
  }
}
