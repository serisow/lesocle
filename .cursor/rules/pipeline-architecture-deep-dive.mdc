---
description:
globs:
alwaysApply: false
---
# Pipeline Architecture Deep Dive

## System Overview
The pipeline system is a sophisticated Drupal-based AI orchestration framework designed to create, manage, and execute complex workflows involving AI models, data processing, and content generation. The system is composed of three interconnected modules:

1. **pipeline**: Core framework for defining and managing pipelines and steps
2. **pipeline_run**: Tracks execution history and provides detailed analytics
3. **pipeline_integration**: Connects pipeline outputs to Drupal entities and external systems

## Core Concepts

### Pipelines
Pipelines (`Pipeline` entity) are configurable sequences of steps that form a workflow. Key characteristics:
- **ConfigEntity-based**: Stored as configuration entities for versioning and deployment
- **Step Collection**: Contains an ordered sequence of step plugins
- **Scheduling**: Supports one-time and recurring scheduling patterns
- **Failure Management**: Auto-disables after configurable failure threshold
- **Execution Context**: Maintains state between steps for data sharing

### Steps
Steps (`StepTypePlugin`) are the individual units of execution within a pipeline. Key characteristics:
- **Plugin-based**: Implemented as Drupal plugins with discovery
- **Configurable**: May have configuration forms for customization
- **Ordered Execution**: Executed based on weight order
- **Context Aware**: Can access results from previous steps
- **Output Typing**: Defines output type for downstream consumption

### Execution Model
The system supports a dual execution model:
- **Drupal-side Execution**: Uses Batch API for manual triggering through UI
- **Go Service Execution**: External Go microservice polls for scheduled pipelines
- **Hybrid Actions**: Some actions can be flagged for Drupal-side execution even when triggered through Go

### Error Handling System
A robust error handling system is implemented via the `PipelineErrorHandler` service:
- Captures PHP errors during execution
- Creates detailed log files in the private filesystem
- Associates errors with specific steps
- Links log files to PipelineRun entities
- Supports both Go service and Drupal-side error reporting


### Entity Relationships
```
Pipeline (ConfigEntity)
  ├── StepTypePlugins (Collection)
  │     ├── LLMStep
  │     ├── ActionStep
  │     ├── UploadImageStep
  │     └── ImageEnrichmentStep
  │
  └── PipelineRun (ContentEntity)
        ├── Step Results
        ├── Execution Metadata
        ├── Context Data
        └── Log Files
```

## Module Functions and Responsibilities

### pipeline module
- Defines all core entities and plugins
- Provides admin UI for pipeline management
- Manages scheduling and API integration
- Handles plugin discovery and instantiation
- Provides base implementations for step types

### pipeline_run module
- Stores execution history as content entities
- Provides analysis and monitoring tools
- Tracks performance metrics
- Manages error logs and failure tracking
- Implements cleanup and archiving

### pipeline_integration module
- Creates Drupal entities from pipeline outputs
- Manages media processing via FFmpeg
- Handles integration with external services
- Implements specialized action plugins
- Provides entity creation strategies

## Execution Flow
1. Pipelines scheduled through admin UI
2. Go service polls `/api/pipelines/scheduled` endpoint
3. Execution begins on Go service side
4. Each step executed in sequence with context sharing
5. Results posted back to `/pipeline/{id}/execution` endpoint
6. PipelineRun entity created with complete execution data
7. Entity creation and media processing handled if needed
8. Metrics and logs stored for analysis

## Data Flow Architecture
```
┌─────────────────────────┐
│    Drupal Admin UI      │
└─┬─────────────┬─────────┘
  │             │
  │ Configure   │ Manual
  │ Pipelines   │ Execute
  │             │
  ▼             ▼
┌─────────────────────────┐     ┌────────────────────────┐
│  Pipeline Module        │◄────┤ API Requests (Polling) │◄───┐
│  ┌───────────────────┐  │     └────────────────────────┘    │
│  │Config Management  │  │                                    │
│  │  - Pipeline       │──┼─────────────┐                      │
│  │  - Steps          │  │             │                      │
│  │  - LLM Config     │  │             │                      │
│  └───────────────────┘  │             │                      │
│  ┌───────────────────┐  │             │                      │
│  │Plugin Management  │  │             │                      │
│  │  - Step Types     │  │             │                      │
│  │  - LLM Services   │  │             │                      │
│  │  - Action Services│  │             │                      │
│  └───────────────────┘  │             │                      │
│  ┌───────────────────┐  │             │                      │
│  │API Controllers    │  │             │                      │
│  │  - Scheduled      │──┼─────────────┼──────────────────────┼───┐
│  │  - Configuration  │  │             │                      │   │
│  │  - Execution      │◄─┼─────────────┼──────────────────────┘   │
│  └───────────────────┘  │             │                          │
└─────────────────────────┘             │                          │
           ▲                            │                          │
           │                            │                          │
           │ Update                     │ Read                     │ Schedule
           │ Run Status                 │ Config                   │ Info
           │                            │                          │
┌──────────┴──────────────┐   ┌────────▼───────────┐    ┌─────────▼─────────┐
│   Pipeline Run Module   │   │Pipeline Integration │    │   Go Service      │
│  ┌───────────────────┐  │   │  ┌───────────────┐ │    │ ┌───────────────┐ │
│  │PipelineRun Entity │  │   │  │Entity Creation│ │    │ │Scheduler      │ │
│  │  - Track Status   │  │   │  │  Strategies   │ │    │ │               │ │
│  │  - Store Results  │◄─┼───┼──┼───────────────┼─┼────┼─┤               │ │
│  │  - Log Files      │  │   │  │Media Services │ │    │ └───────────────┘ │
│  └───────────────────┘  │   │  │  - FFmpeg     │ │    │ ┌───────────────┐ │
│  ┌───────────────────┐  │   │  │  - Imagemagick│ │    │ │Step Execution │ │
│  │UI Components      │  │   │  └───────────────┘ │    │ │  - LLM Calls  │ │
│  │  - Results Viewer │  │   │  ┌───────────────┐ │    │ │  - Actions    │ │
│  │  - Analytics      │  │   │  │External System│ │    │ │  - Processing │ │
│  └───────────────────┘  │   │  │ Integrations  │ │    │ └───────────────┘ │
└─────────────────────────┘   │  │  - Social     │ │    │ ┌───────────────┐ │
                              │  │  - Email/SMS  │─┼────┼▶│Result Posting │ │
                              │  │  - Webhooks   │ │    │ │  - Step Data  │─┼─┐
                              │  └───────────────┘ │    │ │  - Timing Info│ │ │
                              └────────────────────┘    └─────────────────┘ │ │
                                         │                        │         │ │
                                         ▼                        │         │ │
                             ┌──────────────────────────┐         │         │ │
                             │  External Services       │◄────────┘         │ │
                             │  - LLM APIs (OpenAI etc.)│                   │ │
                             │  - Social Networks       │                   │ │
                             │  - Email Services        │                   │ │
                             └──────────────────────────┘                   │ │
                                                                            │ │
                                                                            │ │
                          ┌─────────────────────────────────────────────────┘ │
                          │                                                   │
                          ▼                                                   │
               ┌────────────────────┐                                         │
               │  Drupal Entities   │                                         │
               │  - Content         │◄────────────────────────────────────────┘
               │  - Media           │
               │  - Taxonomy        │
               └────────────────────┘
```

## Advanced Features
- **LLM Integration**: Supports multiple AI providers (OpenAI, Anthropic, Gemini)
- **Media Generation**: Sophisticated image and video creation capabilities
- **Error Recovery**: Robust error handling and recovery mechanisms
- **Performance Monitoring**: Detailed metrics on execution time and resource usage
- **Content Entity Creation**: Automated creation of Drupal entities from AI outputs
- **Social Media Integration**: Direct sharing to multiple platforms 